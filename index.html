<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BALPA Member Search</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --balpa-blue: #003366;
    --balpa-light: #e8f0fe;
    --balpa-accent: #0066cc;
    --border: #d0d5dd;
    --bg: #f8f9fa;
    --white: #ffffff;
    --text: #1a1a2e;
    --text-muted: #667085;
    --success: #12b76a;
    --warning: #f79009;
    --radius: 8px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  .header {
    background: var(--balpa-blue); color: white;
    padding: 16px 24px; display: flex; align-items: center;
    justify-content: space-between; flex-wrap: wrap; gap: 12px;
  }
  .header h1 { font-size: 20px; font-weight: 600; letter-spacing: 0.5px; }
  .header-right { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
  .header-info { font-size: 13px; opacity: 0.85; display: flex; gap: 16px; align-items: center; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
  .status-dot.loaded { background: var(--success); }
  .status-dot.loading { background: var(--warning); animation: pulse 1s infinite; }
  .status-dot.empty { background: #f79009; }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.3} }
  .admin-link { font-size: 12px; color: rgba(255,255,255,0.6); text-decoration: none; border: 1px solid rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 4px; }
  .admin-link:hover { color: white; border-color: white; }

  .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

  .upload-prompt { background: var(--white); border: 2px dashed var(--border); border-radius: var(--radius); padding: 48px 32px; text-align: center; margin-bottom: 20px; }
  .upload-prompt.dragover { border-color: var(--balpa-accent); background: var(--balpa-light); }
  .upload-prompt.hidden { display: none; }
  .upload-icon { width: 48px; height: 48px; margin: 0 auto 16px; background: var(--balpa-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--balpa-accent); }
  .upload-prompt h2 { font-size: 18px; margin-bottom: 8px; color: var(--balpa-blue); }
  .upload-prompt p { font-size: 14px; color: var(--text-muted); margin-bottom: 20px; }
  .upload-btn { display: inline-block; padding: 12px 28px; background: var(--balpa-accent); color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: 500; cursor: pointer; }
  .upload-btn:hover { opacity: 0.9; }
  .upload-prompt .hint { font-size: 12px; color: var(--text-muted); margin-top: 12px; }
  .upload-prompt input[type="file"] { display: none; }
  .auto-loading-bar { background: var(--balpa-light); border-radius: 6px; padding: 10px 16px; margin-bottom: 16px; font-size: 13px; color: var(--balpa-accent); display: flex; align-items: center; gap: 10px; justify-content: center; }
  .mini-spinner { width: 14px; height: 14px; border: 2px solid var(--balpa-light); border-top-color: var(--balpa-accent); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .auto-loading-bar.hidden { display: none; }

  .loaded-banner { background: #ecfdf3; border: 1px solid var(--success); border-radius: var(--radius); padding: 12px 20px; margin-bottom: 20px; display: none; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
  .loaded-banner.visible { display: flex; }
  .loaded-banner h3 { font-size: 14px; color: #067647; }
  .loaded-banner .banner-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .loaded-banner .change-btn { font-size: 12px; color: var(--balpa-accent); background: none; border: 1px solid var(--balpa-accent); border-radius: 4px; padding: 4px 10px; cursor: pointer; }
  .loaded-banner .refresh-btn { font-size: 12px; color: #067647; background: none; border: 1px solid var(--success); border-radius: 4px; padding: 4px 10px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
  .loaded-banner .refresh-btn:hover { background: #d1fadf; }
  .loaded-banner .refresh-btn.spinning .refresh-icon { display: inline-block; animation: spin 0.8s linear infinite; }
  .loaded-timestamp { font-size: 11px; color: #667085; }

  .search-bar { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; margin-bottom: 16px; display: none; }
  .search-bar.visible { display: block; }
  .search-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
  .search-field { flex: 2; min-width: 200px; }
  .filter-field { flex: 1; min-width: 140px; }
  .search-field label, .filter-field label { display: block; font-size: 12px; font-weight: 500; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .search-field input { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 6px; font-size: 15px; outline: none; }
  .search-field input:focus { border-color: var(--balpa-accent); box-shadow: 0 0 0 3px rgba(0,102,204,0.1); }
  .filter-field select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white; cursor: pointer; outline: none; }

  .results-info { display: none; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 4px; }
  .results-info.visible { display: flex; }
  .results-info span { font-size: 13px; color: var(--text-muted); }
  .results-info .count { font-weight: 600; color: var(--text); }
  .clear-btn { font-size: 13px; color: var(--balpa-accent); background: none; border: none; cursor: pointer; text-decoration: underline; }

  .table-wrap { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; display: none; }
  .table-wrap.visible { display: block; }
  .table-scroll { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  thead { background: var(--balpa-blue); color: white; position: sticky; top: 0; z-index: 2; }
  th { padding: 10px 14px; text-align: left; font-weight: 500; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; white-space: nowrap; user-select: none; }
  th:hover { background: rgba(255,255,255,0.1); }
  th .sort-arrow { margin-left: 4px; opacity: 0.5; font-size: 10px; }
  th.sorted .sort-arrow { opacity: 1; }
  td { padding: 10px 14px; border-bottom: 1px solid #f0f0f0; white-space: nowrap; }
  tr:hover td { background: var(--balpa-light); }
  td.match-highlight { font-weight: 600; color: var(--balpa-blue); }

  .copy-btn { padding: 4px 10px; background: var(--balpa-light); border: 1px solid var(--border); border-radius: 4px; font-size: 12px; cursor: pointer; color: var(--balpa-blue); white-space: nowrap; }
  .copy-btn:hover { background: var(--balpa-accent); color: white; border-color: var(--balpa-accent); }
  .copy-btn.copied { background: var(--success); color: white; border-color: var(--success); }

  .pagination { display: none; justify-content: center; align-items: center; gap: 8px; padding: 16px; }
  .pagination.visible { display: flex; }
  .pagination button { padding: 6px 14px; border: 1px solid var(--border); border-radius: 6px; background: white; cursor: pointer; font-size: 13px; }
  .pagination button:hover:not(:disabled) { background: var(--balpa-light); border-color: var(--balpa-accent); }
  .pagination button:disabled { opacity: 0.4; cursor: default; }
  .pagination .page-info { font-size: 13px; color: var(--text-muted); padding: 0 8px; }

  .overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 100; justify-content: center; align-items: center; padding: 20px; }
  .overlay.visible { display: flex; }
  .member-card { background: white; border-radius: 12px; width: 100%; max-width: 480px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); overflow: hidden; }
  .card-header { background: var(--balpa-blue); color: white; padding: 20px 24px; }
  .card-header h3 { font-size: 18px; margin-bottom: 4px; }
  .card-header p { font-size: 13px; opacity: 0.8; }
  .card-body { padding: 20px 24px; }
  .card-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
  .card-row:last-child { border: none; }
  .card-row .label { color: var(--text-muted); font-weight: 500; }
  .card-row .value { font-weight: 600; color: var(--text); text-align: right; max-width: 60%; }
  .card-actions { padding: 16px 24px; border-top: 1px solid #f0f0f0; display: flex; gap: 10px; }
  .card-actions button { flex: 1; padding: 10px; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500; }
  .btn-copy-all { background: var(--balpa-accent); color: white; border: none; }
  .btn-copy-all:hover { opacity: 0.9; }
  .btn-close { background: white; color: var(--text); border: 1px solid var(--border); }

  .toast { position: fixed; bottom: 24px; right: 24px; background: #333; color: white; padding: 10px 20px; border-radius: 8px; font-size: 14px; z-index: 200; opacity: 0; transform: translateY(10px); transition: all 0.3s; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateY(0); }

  @media (max-width: 768px) {
    .container { padding: 12px; }
    .search-row { flex-direction: column; }
    .header { flex-direction: column; align-items: flex-start; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>BALPA easyJet &mdash; Member Search</h1>
  <div class="header-right">
    <div class="header-info">
      <span><span class="status-dot loading" id="statusDot"></span> <span id="statusText">Loading data...</span></span>
      <span id="memberCount"></span>
    </div>
    <a href="https://aquamarine-swan-a14fea.netlify.app/upload.html" class="admin-link" target="_blank">&#8593; Update Data</a>
  </div>
</div>

<div class="container">

  <div class="upload-prompt" id="uploadPrompt">
    <div class="auto-loading-bar" id="autoLoadingBar">
      <div class="mini-spinner"></div>
      Trying to load latest data automatically&hellip;
    </div>
    <div class="upload-icon">&#128269;</div>
    <h2>Load Member Data</h2>
    <p>Select the latest BALPA DATA spreadsheet to get started</p>
    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose Spreadsheet</button>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
    <p class="hint">Or drag and drop the .xlsx file anywhere on this page</p>
  </div>

  <div class="loaded-banner" id="loadedBanner">
    <div>
      <h3 id="loadedMsg">&#10003; Data loaded</h3>
      <span class="loaded-timestamp" id="loadedTimestamp"></span>
    </div>
    <div class="banner-actions">
      <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
        <span class="refresh-icon">&#8635;</span> Refresh
      </button>
      <button class="change-btn" onclick="document.getElementById('fileInput2').click()">
        Load different file
        <input type="file" id="fileInput2" accept=".xlsx,.xls,.csv" style="display:none;">
      </button>
    </div>
  </div>

  <div class="search-bar" id="searchBar">
    <div class="search-row">
      <div class="search-field">
        <label>Search</label>
        <input type="text" id="searchInput" placeholder="Name, staff number, member number..." autocomplete="off">
      </div>
      <div class="filter-field">
        <label>Rank</label>
        <select id="filterRank"><option value="">All Ranks</option></select>
      </div>
      <div class="filter-field">
        <label>Base</label>
        <select id="filterBase"><option value="">All Bases</option></select>
      </div>
      <div class="filter-field">
        <label>Category</label>
        <select id="filterCategory"><option value="">All Categories</option></select>
      </div>
    </div>
  </div>

  <div class="results-info" id="resultsInfo">
    <span>Showing <span class="count" id="resultCount">0</span> members</span>
    <button class="clear-btn" onclick="clearFilters()">Clear filters</button>
  </div>

  <div class="table-wrap" id="tableWrap">
    <div class="table-scroll">
      <table>
        <thead><tr id="tableHead"></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="pagination" id="pagination">
    <button onclick="changePage(-1)" id="prevBtn">&laquo; Prev</button>
    <span class="page-info" id="pageInfo">Page 1 of 1</span>
    <button onclick="changePage(1)" id="nextBtn">Next &raquo;</button>
  </div>
</div>

<div class="overlay" id="overlay" onclick="if(event.target===this)closeCard()">
  <div class="member-card">
    <div class="card-header"><h3 id="cardName"></h3><p id="cardSub"></p></div>
    <div class="card-body" id="cardBody"></div>
    <div class="card-actions">
      <button class="btn-copy-all" onclick="copyMemberDetails()">Copy Details</button>
      <button class="btn-close" onclick="closeCard()">Close</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let allData = [], filteredData = [], currentPage = 1, sortCol = null, sortAsc = true, selectedMember = null;
const PAGE_SIZE = 50;
// Use the GitHub API download URL — this bypasses the CDN cache that raw.githubusercontent.com uses
// The API always returns the current committed file, with no 5-minute delay
const GITHUB_API_URL = 'https://api.github.com/repos/Sopking/BALPA-Member-Look-UP/contents/BALPA%20DATA.xlsx';
const COLS = [
  {key:'StaffNo',label:'Staff No'},{key:'Surname',label:'Surname'},{key:'Forenames',label:'Forenames'},
  {key:'Rank',label:'Rank'},{key:'Base',label:'Base'},{key:'MemberNo',label:'Member No'},
  {key:'Category',label:'Category'},{key:'Sex',label:'Sex'}
];

window.addEventListener('load', autoLoad);

async function fetchFromGitHub() {
  // Fetch via GitHub API — returns JSON with base64-encoded content
  // This bypasses the CDN cache so you always get the latest uploaded file immediately
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 20000);
  try {
    const r = await fetch(GITHUB_API_URL, {
      signal: controller.signal,
      headers: { 'Accept': 'application/vnd.github.v3.raw' }  // raw binary response
    });
    clearTimeout(timeout);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return await r.arrayBuffer();
  } catch(e) {
    clearTimeout(timeout);
    throw e;
  }
}

async function autoLoad() {
  document.getElementById('statusDot').className = 'status-dot loading';
  document.getElementById('statusText').textContent = 'Loading…';
  try {
    const buf = await fetchFromGitHub();
    parseWorkbook(buf, 'latest data');
  } catch(e) {
    console.warn('Auto-load failed:', e.message);
    document.getElementById('autoLoadingBar').classList.add('hidden');
    document.getElementById('statusDot').className = 'status-dot empty';
    document.getElementById('statusText').textContent = 'No data loaded';
  }
}

async function refreshData() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('spinning');
  btn.disabled = true;
  document.getElementById('statusDot').className = 'status-dot loading';
  document.getElementById('statusText').textContent = 'Refreshing…';
  try {
    const buf = await fetchFromGitHub();
    parseWorkbook(buf, 'latest data');
    showToast('Data refreshed successfully');
  } catch(e) {
    showToast('Refresh failed — check your connection');
    document.getElementById('statusDot').className = 'status-dot loaded';
    document.getElementById('statusText').textContent = 'Data loaded';
    console.warn('Refresh failed:', e.message);
  }
  btn.classList.remove('spinning');
  btn.disabled = false;
}

document.getElementById('fileInput').addEventListener('change', e => { if(e.target.files.length) readFile(e.target.files[0]); });
document.getElementById('fileInput2').addEventListener('change', e => { if(e.target.files.length) readFile(e.target.files[0]); });
document.body.addEventListener('dragover', e => { e.preventDefault(); document.getElementById('uploadPrompt').classList.add('dragover'); });
document.body.addEventListener('dragleave', e => { if(!e.relatedTarget||e.relatedTarget===document.documentElement) document.getElementById('uploadPrompt').classList.remove('dragover'); });
document.body.addEventListener('drop', e => { e.preventDefault(); document.getElementById('uploadPrompt').classList.remove('dragover'); if(e.dataTransfer.files.length) readFile(e.dataTransfer.files[0]); });

function readFile(file) {
  const reader = new FileReader();
  reader.onload = e => parseWorkbook(e.target.result, file.name);
  reader.readAsArrayBuffer(file);
}

// Aliases for flexible column detection — add more variations here if needed
const COL_ALIASES = {
  StaffNo:   ['staffno','staff no','staff number','staff_no','employee no','employee number','empno','emp no','payroll no','payroll number'],
  Surname:   ['surname','last name','lastname','family name','familyname'],
  Forenames: ['forenames','forename','first name','firstname','given name','givenname','first names'],
  Rank:      ['rank','grade','position','role','job title','jobtitle'],
  Base:      ['base','home base','homebase','station','location','airport'],
  MemberNo:  ['memberno','member no','member number','membership no','membership number','memno','mem no'],
  Category:  ['category','cat','type','membership type','membershiptype','mem type','memtype'],
  Sex:       ['sex','gender']
};

function detectColMap(headers) {
  // Returns {StaffNo: 'actualHeaderName', ...} for each COLS key
  const map = {};
  const normalized = headers.map(h => ({orig: h, norm: String(h).toLowerCase().replace(/[\s_\-\.]+/g,'')}));
  COLS.forEach(col => {
    // 1. Exact match
    let match = normalized.find(n => n.orig === col.key);
    if (!match) {
      // 2. Case-insensitive exact
      match = normalized.find(n => n.norm === col.key.toLowerCase());
    }
    if (!match) {
      // 3. Alias match (normalized)
      const aliases = COL_ALIASES[col.key] || [];
      for (const alias of aliases) {
        const normAlias = alias.toLowerCase().replace(/[\s_\-\.]+/g,'');
        match = normalized.find(n => n.norm === normAlias);
        if (match) break;
      }
    }
    if (!match) {
      // 4. Contains match (partial)
      const aliases = COL_ALIASES[col.key] || [];
      for (const alias of aliases) {
        const normAlias = alias.toLowerCase().replace(/[\s_\-\.]+/g,'');
        match = normalized.find(n => n.norm.includes(normAlias) || normAlias.includes(n.norm));
        if (match) break;
      }
    }
    if (match) map[col.key] = match.orig;
  });
  return map;
}

function parseWorkbook(buffer, sourceName) {
  try {
    const wb = XLSX.read(buffer, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {defval:''});
    if (!json.length) { showToast('Spreadsheet appears to be empty.'); return; }

    const headers = Object.keys(json[0]);
    const colMap = detectColMap(headers);
    const matched = Object.keys(colMap).length;
    const missing = COLS.map(c=>c.key).filter(k=>!colMap[k]);

    console.log('Spreadsheet columns found:', headers);
    console.log('Column mapping:', colMap);
    if (missing.length) console.warn('Unmapped columns:', missing);

    allData = json.map(row => {
      const m = {};
      COLS.forEach(col => {
        const actualKey = colMap[col.key];
        m[col.key] = actualKey ? String(row[actualKey]||'').trim() : '';
      });
      // Notes column
      const nk = headers.find(h => h.toLowerCase().replace(/[\s_]+/g,'').includes('note'));
      if(nk) m.Notes = String(row[nk]||'').trim();
      return m;
    });

    // Show diagnostic warning if most columns couldn't be matched
    if (matched < 3) {
      showColDiag(headers, colMap, missing);
      return;
    }
    if (missing.length) showToast('⚠ Some columns not matched: ' + missing.join(', ') + '. Check console for details.');
    onDataLoaded(sourceName);
  } catch(err) { showToast('Error reading file: '+err.message); console.error(err); }
}

function showColDiag(headers, colMap, missing) {
  // Show a diagnostic panel so we can see what the spreadsheet calls its columns
  const panel = document.getElementById('colDiagPanel') || (() => {
    const d = document.createElement('div');
    d.id = 'colDiagPanel';
    d.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border:2px solid #c00;border-radius:12px;padding:24px;max-width:560px;width:92vw;z-index:9999;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-height:80vh;overflow-y:auto;';
    document.body.appendChild(d);
    return d;
  })();
  panel.innerHTML = `
    <h3 style="color:#c00;margin-bottom:8px;">⚠ Column Names Not Recognised</h3>
    <p style="font-size:13px;color:#555;margin-bottom:14px;">The app couldn't match the spreadsheet's column headers. Here are the <strong>actual column names</strong> found in the file — please send this list to whoever set up the app so they can fix the mapping:</p>
    <div style="background:#f5f5f5;border-radius:6px;padding:12px;font-family:monospace;font-size:12px;line-height:1.8;word-break:break-all;">
      ${headers.map((h,i) => `<div><strong>${i+1}.</strong> "${h}"</div>`).join('')}
    </div>
    <p style="font-size:12px;color:#888;margin-top:10px;">You can also open the browser console (F12 → Console) to see this list.</p>
    <div style="display:flex;gap:10px;margin-top:16px;">
      <button onclick="document.getElementById('colDiagPanel').remove()" style="padding:8px 18px;background:#003366;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">Close</button>
      <button onclick="navigator.clipboard.writeText(${JSON.stringify(headers.join(', '))}).then(()=>showToast('Column names copied!'))" style="padding:8px 18px;background:#f0f0f0;color:#333;border:1px solid #ccc;border-radius:6px;cursor:pointer;font-size:14px;">Copy Column Names</button>
    </div>`;
}

function onDataLoaded(source) {
  document.getElementById('uploadPrompt').classList.add('hidden');
  document.getElementById('loadedBanner').classList.add('visible');
  document.getElementById('loadedMsg').innerHTML = '&#10003; '+allData.length.toLocaleString()+' members loaded \u2014 '+source;
  // Show timestamp so users know how fresh the data is
  const now = new Date();
  const ts = now.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit'}) + ' on ' + now.toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'});
  document.getElementById('loadedTimestamp').textContent = 'Last updated: ' + ts;
  document.getElementById('statusDot').className = 'status-dot loaded';
  document.getElementById('statusText').textContent = 'Data loaded';
  document.getElementById('memberCount').textContent = allData.length.toLocaleString()+' members';
  populateFilter('filterRank','Rank','All Ranks');
  populateFilter('filterBase','Base','All Bases');
  populateFilter('filterCategory','Category','All Categories');
  ['searchBar','resultsInfo','tableWrap','pagination'].forEach(id => document.getElementById(id).classList.add('visible'));
  buildTableHead(); applyFilters();
  document.getElementById('searchInput').focus();
}

function populateFilter(id, key, label) {
  const sel = document.getElementById(id);
  const vals = [...new Set(allData.map(r=>r[key]).filter(Boolean))].sort();
  sel.innerHTML = '<option value="">'+label+'</option>';
  vals.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
}

function buildTableHead() {
  const tr = document.getElementById('tableHead'); tr.innerHTML='';
  COLS.forEach((col,i) => { const th=document.createElement('th'); th.innerHTML=col.label+' <span class="sort-arrow">&#9650;</span>'; th.onclick=()=>toggleSort(i); tr.appendChild(th); });
  const th=document.createElement('th'); th.style.cursor='default'; tr.appendChild(th);
}

document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 150));
['filterRank','filterBase','filterCategory'].forEach(id => document.getElementById(id).addEventListener('change', applyFilters));

function applyFilters() {
  const q=document.getElementById('searchInput').value.toLowerCase().trim();
  const rank=document.getElementById('filterRank').value, base=document.getElementById('filterBase').value, cat=document.getElementById('filterCategory').value;
  filteredData = allData.filter(row => {
    if(rank&&row.Rank!==rank) return false;
    if(base&&row.Base!==base) return false;
    if(cat&&row.Category!==cat) return false;
    if(q) { const s=(row.StaffNo+' '+row.Surname+' '+row.Forenames+' '+row.MemberNo).toLowerCase(); if(!q.split(/\s+/).every(t=>s.includes(t))) return false; }
    return true;
  });
  if(sortCol!==null) { const k=COLS[sortCol].key; filteredData.sort((a,b)=>{const va=a[k].toLowerCase(),vb=b[k].toLowerCase();return sortAsc?(va<vb?-1:va>vb?1:0):(va<vb?1:va>vb?-1:0);}); }
  currentPage=1; renderTable();
}

function clearFilters() { document.getElementById('searchInput').value=''; ['filterRank','filterBase','filterCategory'].forEach(id=>document.getElementById(id).value=''); sortCol=null; sortAsc=true; applyFilters(); }

function toggleSort(i) {
  sortAsc = (sortCol===i) ? !sortAsc : true; sortCol=i;
  document.querySelectorAll('#tableHead th').forEach((th,j) => { th.classList.toggle('sorted',j===i); const a=th.querySelector('.sort-arrow'); if(a) a.innerHTML=(j===i&&!sortAsc)?'&#9660;':'&#9650;'; });
  applyFilters();
}

function renderTable() {
  const tbody=document.getElementById('tableBody'), q=document.getElementById('searchInput').value.toLowerCase().trim();
  const start=(currentPage-1)*PAGE_SIZE, page=filteredData.slice(start,start+PAGE_SIZE);
  document.getElementById('resultCount').textContent=filteredData.length.toLocaleString();
  tbody.innerHTML='';
  page.forEach(row => {
    const tr=document.createElement('tr'); tr.style.cursor='pointer'; tr.onclick=e=>{if(e.target.classList.contains('copy-btn'))return;openCard(row);};
    COLS.forEach(col => { const td=document.createElement('td'); td.textContent=row[col.key]; if(q&&row[col.key].toLowerCase().includes(q))td.classList.add('match-highlight'); tr.appendChild(td); });
    const td=document.createElement('td'), btn=document.createElement('button'); btn.className='copy-btn'; btn.textContent='Copy'; btn.onclick=e=>{e.stopPropagation();copyRowText(row,btn);}; td.appendChild(btn); tr.appendChild(td); tbody.appendChild(tr);
  });
  const total=Math.max(1,Math.ceil(filteredData.length/PAGE_SIZE));
  document.getElementById('pageInfo').textContent='Page '+currentPage+' of '+total;
  document.getElementById('prevBtn').disabled=currentPage<=1;
  document.getElementById('nextBtn').disabled=currentPage>=total;
}

function changePage(dir) { currentPage=Math.max(1,Math.min(Math.ceil(filteredData.length/PAGE_SIZE),currentPage+dir)); renderTable(); document.getElementById('tableWrap').scrollIntoView({behavior:'smooth'}); }

function openCard(row) {
  selectedMember=row;
  document.getElementById('cardName').textContent=row.Forenames+' '+row.Surname;
  document.getElementById('cardSub').textContent=row.Rank+' · '+row.Base+' · '+row.Category;
  const body=document.getElementById('cardBody'); body.innerHTML='';
  [['Staff Number',row.StaffNo],['Member Number',row.MemberNo],['Rank',row.Rank],['Base',row.Base],['Category',row.Category],['Sex',row.Sex],...(row.Notes?[['Notes',row.Notes]]:[])].forEach(([l,v])=>{const d=document.createElement('div');d.className='card-row';d.innerHTML='<span class="label">'+l+'</span><span class="value">'+(v||'—')+'</span>';body.appendChild(d);});
  document.getElementById('overlay').classList.add('visible');
}

function closeCard() { document.getElementById('overlay').classList.remove('visible'); selectedMember=null; }

function copyMemberDetails() {
  if(!selectedMember) return;
  const r=selectedMember;
  navigator.clipboard.writeText([r.Forenames+' '+r.Surname,'Staff No: '+r.StaffNo,'Member No: '+r.MemberNo,'Rank: '+r.Rank,'Base: '+r.Base,'Category: '+r.Category,...(r.Notes?['Notes: '+r.Notes]:[])].join('\n')).then(()=>showToast('Member details copied'));
}

function copyRowText(row,btn) {
  navigator.clipboard.writeText(row.Forenames+' '+row.Surname+' | '+row.StaffNo+' | '+row.Rank+' | '+row.Base+' | '+row.MemberNo).then(()=>{btn.textContent='Copied!';btn.classList.add('copied');setTimeout(()=>{btn.textContent='Copy';btn.classList.remove('copied');},1500);});
}

document.addEventListener('keydown', e => { if(e.key==='Escape')closeCard(); if(e.key==='/'&&!['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)){e.preventDefault();document.getElementById('searchInput').focus();} });
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
</script>
</body>
</html>
